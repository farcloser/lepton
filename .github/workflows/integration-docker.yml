name: test-docker

on:
  push:
    branches:
      - main
      - 'release/**'
  # Only trigger on PRs if we changed a test file, or any of the test rig or actions assets
  pull_request:
    paths:
      - '**_test.go'
      - '**.sh'
      - '**.toml'
      - '**.conf'
      - '**.service'
      - '**.yml'

env:
  # Note: most short runs are way below 5, except windows, which is very slow and cache hit 5+ with cold cache
  TIMEOUT_SHORT: 10
  LONG_TIMEOUT: 60

jobs:
  test-integration-docker-compatibility:
    timeout-minutes: 30
    name: docker
    runs-on: ubuntu-24.04
    steps:
      - name: "Clone"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - name: "Install go"
        uses: ./.github/actions/install-go
      - name: "Install dev-tools"
        uses: ./.github/actions/install-dev-tools
      # FIXME: finish migrating unbuffer tests out
      - name: "Add expect"
        run: |
          sudo apt-get install -qq --no-install-recommends expect
      - name: "Register QEMU"
        run: |
          docker run --privileged --rm tonistiigi/binfmt --install linux/amd64
          docker run --privileged --rm tonistiigi/binfmt --install linux/arm64
      - name: "Ensure that the integration test suite is compatible with Docker"
        run: WITH_SUDO=true ./hack/test-integration.sh -test.target=docker
      - name: "Ensure that the IPv6 integration test suite is compatible with Docker"
        run: WITH_SUDO=true ./hack/test-integration.sh -test.target=docker -test.only-ipv6
      - name: "Ensure that the integration test suite is compatible with Docker (flaky only)"
        run: WITH_SUDO=true ./hack/test-integration.sh -test.target=docker -test.only-flaky
